<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QA Test Cases Generator</title>
    <link rel="stylesheet" href="popup.css">
</head>
<body>
    <div class="popup-container" id="app" x-data="popupApp()" x-cloak>
        <!-- Header -->
        <header class="popup-header">
            <img src="../assets/icons/icon-48.png" alt="Logo" class="popup-logo">
            <h1 class="popup-title">Test Cases Generator</h1>
        </header>

        <!-- Loading Overlay -->
        <div x-show="loading" class="overlay">
            <div class="overlay-content">
                <div class="spinner"></div>
                <p class="overlay-text">Génération des test cases en cours...</p>
                <p class="overlay-subtext">L'IA analyse votre User Story</p>
            </div>
        </div>

        <!-- Injection Overlay -->
        <div x-show="injecting" class="overlay">
            <div class="overlay-content">
                <h3 class="overlay-title">Injection dans Xray</h3>
                <div class="progress-steps">
                    <div class="step" :class="{'active': !injectionSteps.testsInserted, 'completed': injectionSteps.testsInserted}">
                        <div class="step-indicator">1</div>
                        <span>Insertion</span>
                    </div>
                    <div class="step-line" :class="{'completed': injectionSteps.testsInserted}"></div>
                    <div class="step" :class="{'active': injectionSteps.testsInserted && !injectionSteps.testsLinked, 'completed': injectionSteps.testsLinked}">
                        <div class="step-indicator">2</div>
                        <span>Liaison US</span>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" :style="`width: ${injectionProgress}%`"></div>
                </div>
                <div x-show="injectionSteps.testsLinked" class="success-message">
                    <p>Test cases injectés avec succès !</p>
                    <button @click="resetAll()" class="btn btn-primary">Nouveau</button>
                </div>
            </div>
        </div>

        <!-- Review Mode -->
        <div x-show="reviewMode" x-cloak>
            <div class="review-header">
                <h3>Revue des test cases</h3>
                <p class="review-count"><span x-text="testCases.length"></span> test case(s) pour <strong x-text="jiraKey"></strong></p>
            </div>
            <div class="test-cases-list">
                <template x-for="(tc, index) in testCases" :key="index">
                    <div class="test-case-card" :class="{'deselected': !tc.selected}">
                        <div class="test-case-header">
                            <input type="checkbox" class="test-case-checkbox" x-model="tc.selected">
                            <span class="test-case-number" x-text="`#${index + 1}`"></span>
                            <span class="test-case-title" :title="tc._displayTitle" x-text="tc._displayTitle"></span>
                            <span class="test-case-type" x-text="tc._displayType"></span>
                        </div>
                        <div class="test-case-preview" x-text="tc._displaySteps.split('\n')[0]"></div>
                    </div>
                </template>
            </div>
            <div class="review-actions">
                <button @click="cancelReview()" class="btn btn-secondary">Annuler</button>
                <div class="review-actions-right">
                    <span x-text="`${selectedCount}/${testCases.length}`"></span>
                    <button @click="handleInject()" class="btn btn-primary" :disabled="selectedCount === 0">Injecter</button>
                </div>
            </div>
        </div>

        <!-- Form -->
        <form @submit.prevent="handleSubmit()" class="popup-form" x-show="!reviewMode && !injecting">
            <!-- Auto-detected Jira info -->
            <div x-show="jiraDetected" class="jira-detected">
                <span class="jira-badge">Auto-détecté</span>
                <span class="detected-key" x-text="detectedJiraKeyDisplay"></span>
            </div>

            <!-- Jira ID Field -->
            <div class="form-group">
                <label for="jira-key">Jira User Story ID *</label>
                <input type="text" id="jira-key" name="jira-key" placeholder="HOTEL-123" x-model="jiraKey" required>
                <p x-show="showJiraError" class="error-message">Le champ Jira ID est obligatoire</p>
            </div>

            <!-- Format Field -->
            <div class="form-group">
                <label for="format">Format de sortie</label>
                <select id="format" name="format" x-model="format" @change="savePreferences()">
                    <option value="gherkin">Gherkin</option>
                    <option value="step-by-step">Step-by-step</option>
                </select>
            </div>

            <!-- Prompt Field -->
            <div class="form-group">
                <label for="prompt">Instruction complémentaire</label>
                <textarea id="prompt" name="prompt" rows="2" placeholder="Ex: Inclure les tests de validation..." x-model="prompt"></textarea>
            </div>

            <!-- Messages -->
            <div x-show="successMessage" class="message message-success">
                <p x-text="successMessage"></p>
            </div>
            <div x-show="errorMessage" class="message message-error">
                <p x-text="errorMessage"></p>
            </div>

            <!-- Submit Button -->
            <button type="submit" class="btn btn-primary btn-full" :disabled="loading">
                Générer les test cases
            </button>
        </form>

        <!-- Footer -->
        <footer class="popup-footer">
            <span>Powered by n8n</span>
        </footer>
    </div>

    <script src="popup.js" type="module"></script>
</body>
</html>
